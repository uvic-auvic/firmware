REPO_ROOT=$(CURDIR)/../..
COMPONENT_DIR=$(REPO_ROOT)/powerboard1
COMPONENT_SHARED_CODE_DIR=$(COMPONENT_DIR)/code/shared
SHARED_DIR=$(REPO_ROOT)/shared
SHARED_CODE_DIR=$(REPO_ROOT)/shared/code
CODE_DIR=$(COMPONENT_DIR)/code/$(TARGET)
SHARED_MAKEFILES=$(REPO_ROOT)/shared/makefiles

ifeq ($(DEVICE), STM32F051)
	LINKER_SCRIPT= $(CODE_DIR)/startup/STM32F051R8_FLASH.ld

	DEVICE_DEFINES+= \
	-DSTM32 \
	-DSTM32F0 \
	-DSTM32F051 \
	-DDEVICE_STM32F051=1

	DEVICE=STM32F051

	MCU_ARCHITECTURE=M0

else # STM32F091
	LINKER_SCRIPT= $(CODE_DIR)/startup/STM32F091CC_FLASH.ld

	DEVICE_DEFINES+= \
	-DSTM32 \
	-DSTM32F0 \
	-DSTM32F091 \
	-DSTM32F091RCTx \
	-DDEVICE_STM32F091=1

	DEVICE=STM32F091

	MCU_ARCHITECTURE=M0

endif

ifeq ($(TARGET),clean)
        OUTPUT_DIR=$(COMPONENT_DIR)/POWERBOARD1
else
        OUTPUT_DIR=$(COMPONENT_DIR)/POWERBOARD1/$(TARGET)/$(DEVICE)
endif

OTHER_DEFINES+= \
-DUSE_STDPERIPH_DRIVER

INCLUDE_PATH+= \
-I$(COMPONENT_SHARED_CODE_DIR)/config \
-I$(CODE_DIR) \
-I$(CODE_DIR)/RTOS

-include $(SHARED_MAKEFILES)/FreeRTOSlib.mk
-include STMLib.mk
-include app.mk
-include appStartup.mk

ARM_TOOLS_COMPILER_MCU_SETTINGS := -mcpu=cortex-m0 -mthumb -mfloat-abi=soft
ARM_TOOLS_COMPILER_DEFINES := $(DEVICE_DEFINES) $(OTHER_DEFINES)
ARM_TOOLS_COMPILER_INCLUDE_PATH := $(INCLUDE_PATH)

-include $(SHARED_MAKEFILES)/armTools.mk

TARGET_ELF=$(OUTPUT_DIR)/powerboard1_$(TARGET).elf
TARGET_BIN=$(OUTPUT_DIR)/powerboard1_$(TARGET).bin
TARGET_HEX=$(OUTPUT_DIR)/powerboard1_$(TARGET).hex
TARGET_MAP=$(OUTPUT_DIR)/powerboard1_$(TARGET).map

APP_LINKER_OPTIONS:=\
-Xlinker -nmagic

ARM_TOOL_LINKER_LIBRARIES := \
-lm

ARM_TOOLS_LINKER_SCRIPT := $(LINKER_SCRIPT)
ARM_TOOLS_LINKER_TARGET_MAP := $(TARGET_MAP)
ARM_TOOLS_LINKER_TARGET_ELF := $(TARGET_ELF)

app: $(LIB_OBJS) $(APP_OBJS) $(LINKER_SCRIPT)
	@$(MAKE) arm-linker ARM_TOOLS_LINKER_OBJECT_FILES="$(LIB_OBJS) $(PROTO_OBJS) $(APP_OBJS)" ARM_TOOL_LINKER_OPTIONS="$(APP_LINKER_OPTIONS)" ARM_TOOL_LINKER_LIBRARIES="$(ARM_TOOL_LINKER_LIBRARIES)"
	@$(MAKE) --no-print-directory post-build

all: app

post-build: $(TARGET_ELF)
	-@echo 'Generating binary and Printing size information:'
	arm-none-eabi-objcopy -O binary "$(TARGET_ELF)" "$(TARGET_BIN)"
	arm-none-eabi-objcopy -O ihex "$(TARGET_ELF)" "$(TARGET_HEX)"
	arm-none-eabi-size "$(TARGET_ELF)"
	-@echo ' '

clean:
	rm -rf $(OUTPUT_DIR)

.PHONY: all clean dependents
.SECONDARY: post-build

-include $(LIB_C_DEPS)
-include $(APP_C_DEPS)
